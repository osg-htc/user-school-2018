<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://opensciencegrid.github.io/user-school-2018/materials/day2/part1-ex3-submit-osg/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Exercise 1.3 - OSG User School 2018</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Tuesday Exercise 1.3: Running jobs in the OSG", url: "#_top", children: [
              {title: "Where in the world are my jobs? (Part 2)", url: "#where-in-the-world-are-my-jobs-part-2" },
              {title: "Mapping your jobs", url: "#mapping-your-jobs" },
              {title: "Extra Challenge: Running it all as a DAG", url: "#extra-challenge-running-it-all-as-a-dag" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <h1 id="tuesday-exercise-13-running-jobs-in-the-osg">Tuesday Exercise 1.3: Running jobs in the OSG<a class="headerlink" href="#tuesday-exercise-13-running-jobs-in-the-osg" title="Permanent link">&para;</a></h1>
<p>The goal of this exercise is to have your jobs running on the OSG and map their geographical locations.</p>
<h2 id="where-in-the-world-are-my-jobs-part-2">Where in the world are my jobs? (Part 2)<a class="headerlink" href="#where-in-the-world-are-my-jobs-part-2" title="Permanent link">&para;</a></h2>
<p>In this version of the geolocating exercise, you will submit jobs to the OSG from <code>osg-learn.chtc.wisc.edu</code> and
hopefully getting back much more interesting results!
Due to some differences between the machines in the OSG and our local cluster here at UW-Madison, you will be using a
slightly different payload and then performing the geolocation on the results from the submit host.</p>
<h3 id="hostname-fetching-code">Hostname fetching code<a class="headerlink" href="#hostname-fetching-code" title="Permanent link">&para;</a></h3>
<p>The following Python script finds the ClassAd of the machine it's running on and finds a network identity that can be
used to perform lookups:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/bin/env python</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">machine_ad_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;_CONDOR_MACHINE_AD&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">machine_ad_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">machine_ad_file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">machine_ad</span> <span class="o">=</span> <span class="n">machine_ad_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">machine_ad_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">()</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;GLIDEIN_Gatekeeper = &quot;(.*):\d*/jobmanager-\w*&quot;&#39;</span><span class="p">,</span>
                    <span class="n">machine_ad</span><span class="p">,</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;GLIDEIN_Gatekeeper = &quot;(\S+) \S+:9619&quot;&#39;</span><span class="p">,</span>
                        <span class="n">machine_ad</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<h3 id="gathering-network-information-from-the-osg">Gathering network information from the OSG<a class="headerlink" href="#gathering-network-information-from-the-osg" title="Permanent link">&para;</a></h3>
<p>Now to create submit files that will run in the OSG!</p>
<ol>
<li>If not already logged in, <code>ssh</code> into <code>osg-learn.chtc.wisc.edu</code></li>
<li>Make a new directory for this exercise, <code>tuesday-1.3</code> and change into it</li>
<li>Save the above <a href="#hostname-fetching-code">hostname fetching code</a> script to a file and call it <code>ce_hostname.py</code></li>
<li>Create a submit file that runs <code>ce_hostname.py</code> 100 times and uses the <code>$(Process)</code> macro to write different <code>output</code>
   and <code>error</code> files</li>
<li>Submit your file and wait for the results</li>
</ol>
<h3 id="geolocating-machines-in-the-osg">Geolocating machines in the OSG<a class="headerlink" href="#geolocating-machines-in-the-osg" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Submit host etiquette</p>
<p>In this section, we are bending a rule about running jobs locally on the submit host because this host is a closed
environment only utilized by the class and this exercise is designed for low load.
Normally you should <strong>NOT</strong> run jobs on your submit host.</p>
</div>
<p>You will be re-using the Python script from the the last exercise to perform the geolocation except instead of
submitting it as a job, you will run it manually.
Copy it over from <code>learn.chtc.wisc.edu</code> using <code>scp</code> with the following command:</p>
<ol>
<li>Log in to <code>learn.chtc.wisc.edu</code></li>
<li>Copy the file over to <code>osg-learn.chtc.wisc.edu</code>:<div class="codehilite"><pre><span></span><span class="gp">user@learn $</span> scp tuesday-1.1/location.py osg-learn.chtc.wisc.edu:tuesday-1.3/
</pre></div>


</li>
</ol>
<p><code>location.py</code> can take a text file that contains a list of locations as an argument, which can be done by collating your
output files into a single file.
The easiest way to do this is to use the <code>cat</code> command from today's exercise 1.2, the <code>*</code> wildcard from last exercise
and a new operator <code>&gt;</code>, which can write command output to a file.
If your output files are named <code>ce_hostname-0.out...ce_hostname-99.out</code>, your commands would look like this:</p>
<div class="codehilite"><pre><span></span><span class="gp">user@osg-learn $</span> cat ce_hostname-*.out &gt; hostnames.txt
<span class="gp">user@osg-learn $</span> ./location.py hostnames.txt
</pre></div>


<h2 id="mapping-your-jobs">Mapping your jobs<a class="headerlink" href="#mapping-your-jobs" title="Permanent link">&para;</a></h2>
<p>As before, you will be using <a href="http://www.mapcustomizer.com/">http://www.mapcustomizer.com/</a> from <code>osg-learn.chtc.wisc.edu</code> to visualize where your jobs
have landed in the OSG.
Copy and paste the results from the Python script into the bulk creation text box at the bottom of the screen. Where did
your jobs end up?</p>
<h2 id="extra-challenge-running-it-all-as-a-dag">Extra Challenge: Running it all as a DAG<a class="headerlink" href="#extra-challenge-running-it-all-as-a-dag" title="Permanent link">&para;</a></h2>
<p>Yesterday, you learned about DAGs and you can take advantage of them to avoid manually running <code>location.py</code> by hand.
You could make this exercise into DAG with the hostname fetching submit file followed by a submit file that calls the
geolocation code.
You'll need to leverage <code>PRE</code> and/or <code>POST</code> scripts to collate the hostname results, which can be done with a little bit
of shell scripting!
To create a shell script:</p>
<ol>
<li>Write a file with a <code>.sh</code> extension</li>
<li>
<p>Add a bash "shebang" line to the top of the script and lines for each shell command that you'd like to run (imagine
    it as a terminal in file form).
    For example, the following shell script would create a directory <code>foo</code> then list its contents:</p>
<div class="codehilite"><pre><span></span><span class="c1">#/bin/bash</span>
mkdir foo
ls foo
</pre></div>


</li>
<li>
<p>Mark the script as executable</p>
</li>
<li>Run it by hand to verify that it works</li>
</ol>
<p>What did your results look this time around via DAG?</p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part2-ex1-hardware-diffs/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part2-ex1-hardware-diffs/" class="btn btn-xs btn-link">
        Exercise 2.1
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part1-ex2-login-scp/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part1-ex2-login-scp/" class="btn btn-xs btn-link">
        Exercise 1.2
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>